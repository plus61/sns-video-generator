#!/bin/bash

# Worker3 30åˆ†ã”ã¨ã®è‡ªå‹•å ±å‘Šã‚·ã‚¹ãƒ†ãƒ 
# ã‚·ãƒ³ãƒ—ãƒ«ãƒ»åŠ¹æœçš„ãƒ»å³å®Ÿè¡Œå¯èƒ½

REPORT_FILE="test-report-$(date +%Y%m%d).md"
LOG_FILE="test-monitor.log"

generate_report() {
    echo "ğŸ“Š ãƒ†ã‚¹ãƒˆæˆåŠŸç‡å ±å‘Šæ›¸ç”Ÿæˆä¸­..."
    
    # æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
    if [ -f "$LOG_FILE" ]; then
        LATEST=$(tail -1 $LOG_FILE)
        IFS=',' read -r TIMESTAMP TOTAL PASSED FAILED RATE <<< "$LATEST"
        
        # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        cat > "$REPORT_FILE" << EOF
# ãƒ†ã‚¹ãƒˆæˆåŠŸç‡å ±å‘Šæ›¸
ç”Ÿæˆæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')

## ğŸ“Š ç¾åœ¨ã®çŠ¶æ³
- **æˆåŠŸç‡**: ${RATE}%
- **ç›®æ¨™**: 90%ä»¥ä¸Š
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: $([ $RATE -ge 90 ] && echo "âœ… é”æˆ" || echo "âš ï¸ æœªé”æˆ")

## ğŸ“ˆ è©³ç´°ãƒ‡ãƒ¼ã‚¿
| é …ç›® | æ•°å€¤ |
|------|------|
| ç·ãƒ†ã‚¹ãƒˆæ•° | $TOTAL |
| æˆåŠŸ | $PASSED |
| å¤±æ•— | $FAILED |

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
$(if [ $RATE -lt 90 ]; then
    echo "- å¤±æ•—ãƒ†ã‚¹ãƒˆã®åŸå› åˆ†æãŒå¿…è¦"
    echo "- ã‚»ãƒ¬ã‚¯ã‚¿ã®å…·ä½“åŒ–ã‚’æ¨å¥¨"
    echo "- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã®èª¿æ•´ã‚’æ¤œè¨"
else
    echo "- ç›®æ¨™é”æˆï¼ç¾çŠ¶ç¶­æŒã‚’æ¨å¥¨"
    echo "- æ›´ãªã‚‹å“è³ªå‘ä¸Šã®ä½™åœ°ã‚’æ¢ç´¢"
fi)

---
*Worker3 è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ*
EOF
        
        echo "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: $REPORT_FILE"
        
        # ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ã‚‚è¡¨ç¤º
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š 30åˆ†å ±å‘Šã‚µãƒãƒªãƒ¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "æˆåŠŸç‡: ${RATE}%"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $([ $RATE -ge 90 ] && echo "âœ… ç›®æ¨™é”æˆ" || echo "âš ï¸ æ”¹å–„å¿…è¦")"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
        echo "âŒ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    fi
}

# åˆå›ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
generate_report

# 30åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
echo ""
echo "â° 30åˆ†ã”ã¨ã«è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹..."
echo "Ctrl+Cã§åœæ­¢"

while true; do
    sleep 1800  # 30åˆ†å¾…æ©Ÿ
    echo ""
    generate_report
done